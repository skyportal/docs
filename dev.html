<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developer notes &mdash; skyportal 0.9.dev0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/output_cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Deployment" href="deploy.html" />
    <link rel="prev" title="API" href="api.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> skyportal
          </a>
              <div class="version">
                0.9.dev0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="design.html">System Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pre-commit-hook">Pre-commit hook</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing">Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#test-fixtures">Test fixtures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#debugging">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#database">Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#docker-images">Docker images</a></li>
<li class="toctree-l2"><a class="reference internal" href="#debugging-github-actions">Debugging GitHub Actions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deploy.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_loader.html">Data loader</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">How to Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="adding_features.html">Adding new features</a></li>
<li class="toctree-l1"><a class="reference internal" href="styling.html">Styling components</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrations.html">Database migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="query_analysis.html">Analyzing database queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="permissions.html">Access controls</a></li>
<li class="toctree-l1"><a class="reference internal" href="slack.html">Slack Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="mma.html">MMA Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_usage.html">Advanced usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="analysis.html">Analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">skyportal</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Developer notes</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="developer-notes">
<h1>Developer notes<a class="headerlink" href="#developer-notes" title="Permalink to this heading"></a></h1>
<section id="pre-commit-hook">
<h2>Pre-commit hook<a class="headerlink" href="#pre-commit-hook" title="Permalink to this heading"></a></h2>
<p>Install our pre-commit hook as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">pre</span><span class="o">-</span><span class="n">commit</span>
<span class="n">pre</span><span class="o">-</span><span class="n">commit</span> <span class="n">install</span>
</pre></div>
</div>
<p>This will check your changes before each commit to ensure that they
conform with our code style standards. We use black to reformat Python
code, and PrettierJS for JavaScript. We also run ESLint to catch
several common Redux usage bugs.</p>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this heading"></a></h2>
<p>To execute the test suite:</p>
<ul class="simple">
<li><p>Install geckodriver and Firefox</p></li>
<li><p>To run all tests: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code></p></li>
<li><p>To run a single test: <code class="docutils literal notranslate"><span class="pre">./baselayer/tools/test_frontend.py</span> <span class="pre">skyportal/tests/frontend/&lt;test_file&gt;.py::test_&lt;specific_test&gt;</span></code></p></li>
</ul>
<p>This fires up the test server and runs that test. To make things
faster you can also run the test server separately:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">run_testing</span>   <span class="c1"># fire up the server with `test_conf.yaml`</span>

<span class="n">pytest</span> <span class="n">skyportal</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">api</span>  <span class="c1"># test api</span>
<span class="n">pytest</span> <span class="n">skyportal</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">frontend</span><span class="o">/</span><span class="n">test_user</span><span class="o">.</span><span class="n">py</span>  <span class="c1"># run subset of frontend tests</span>
<span class="n">pytest</span> <span class="n">skyportal</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">frontend</span><span class="o">/</span><span class="n">test_user</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_user_profile_fetching</span>  <span class="c1"># run a single test</span>
</pre></div>
</div>
<p>On Linux, the tests can be run in “headless” mode (no browser display):</p>
<ul class="simple">
<li><p>Install xvfb (<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">xvfb</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test_headless</span></code></p></li>
</ul>
<p>Or, as described above, launch the test server with <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">run_testing</span></code>, and then call</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xvfb</span><span class="o">-</span><span class="n">run</span> <span class="n">pytest</span> <span class="n">skyportal</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">frontend</span><span class="o">/</span><span class="n">test_user</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>It is not noticeably faster to run the test suite headlessly.</p>
<section id="test-fixtures">
<h3>Test fixtures<a class="headerlink" href="#test-fixtures" title="Permalink to this heading"></a></h3>
<p>The SkyPortal test suite leverages pytest fixtures to generate and isolate test data for each test. Fixtures are declared in the <code class="docutils literal notranslate"><span class="pre">skyportal/tests/conftest.py</span></code> file, and they utilize factories implemented in <code class="docutils literal notranslate"><span class="pre">skyportal/tests/fixtures.py</span></code> to generate new instances of fixtures as needed.</p>
<p>Each test will request any fixtures that it requires, and as part of the set-up for that test, new test instances of the fixtures are created. This means that each test is guaranteed to work with fresh, isolated test data in order to avoid any unintended dependencies on other tests. Fixtures should be used when possible in writing new tests to promote safe, repeatable test results.</p>
<p>SkyPortal test fixtures are implemented with teardown logic, such that any database records generated for that fixture are deleted from the test database upon completion of a test. This serves to avoid bloating of the test database as more tests are run. Note that each fixture defined in <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> uses the <code class="docutils literal notranslate"><span class="pre">yield</span></code> keyword to return its test object. Any code following <code class="docutils literal notranslate"><span class="pre">yield</span></code> in a pytest fixture is run as teardown logic when that fixture goes out of scope; you will find that in SkyPortal this involves calling the relevant <code class="docutils literal notranslate"><span class="pre">teardown()</span></code> functions on the fixture objects created. These <code class="docutils literal notranslate"><span class="pre">teardown()</span></code> functions are implemented for each SQLAlchemyModelFactory subclass defined in <code class="docutils literal notranslate"><span class="pre">fixtures.py</span></code>.</p>
<p>Any new fixtures and fixture factories being added should follow this same structure, taking care to delete all fixture data (including SubFactory-generated records, i.e. a new User created to be the author of a new Comment). Foreign key constraints and cascade behavior defined on the database models can be used to simplify this logic but can also lead to subtle errors in tearing down fixtures and should be taken into careful consideration.</p>
</section>
</section>
<section id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">log</span></code> to watch log output</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">stop</span></code> to stop any running web services.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">attach</span></code> to attach to output of webserver, e.g. for use with <code class="docutils literal notranslate"><span class="pre">pdb.set_trace()</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check-js-updates</span></code> to see which Javascript packages are eligible for an upgrade.</p></li>
</ul>
</section>
<section id="database">
<h2>Database<a class="headerlink" href="#database" title="Permalink to this heading"></a></h2>
<p>All interactions with the database are performed by way of SQLAlchemy using the
Pyscopg2 backend. Some standard but not necessarily obvious usage patterns we
make use of include:</p>
<ul class="simple">
<li><p>Logic for connecting to the DB, refreshing tables, etc. is found in <code class="docutils literal notranslate"><span class="pre">baselayer/model_utils.py</span></code>:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">baselayer.app.env</span> <span class="kn">import</span> <span class="n">load_env</span>
<span class="kn">from</span> <span class="nn">skyportal.models</span> <span class="kn">import</span> <span class="n">DBSession</span><span class="p">,</span> <span class="n">init_db</span>
<span class="n">env</span><span class="p">,</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">load_env</span><span class="p">()</span>
<span class="n">init_db</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">])</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The session object controls various DB state operations:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DBSession</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># add a new object into the DB</span>
<span class="n">DBSession</span><span class="p">()</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># commit modifications to objects</span>
<span class="n">DBSession</span><span class="p">()</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>  <span class="c1"># recover after a DB error</span>
</pre></div>
</div>
<p>For more information on how to use the session, see <code class="docutils literal notranslate"><span class="pre">baselayer/doc/dev.md</span></code>.</p>
<ul class="simple">
<li><p>Generic logic applicable to any model is included in the base model class <code class="docutils literal notranslate"><span class="pre">baselayer.app.models.Base</span></code> (<code class="docutils literal notranslate"><span class="pre">to_dict</span></code>, <code class="docutils literal notranslate"><span class="pre">__str__</span></code>, etc.), but can be overridden within a specific model</p></li>
<li><p>Models can be queried directly (<code class="docutils literal notranslate"><span class="pre">User.query.all()</span></code>), or more specific queries can be constructed via the session object (<code class="docutils literal notranslate"><span class="pre">DBSession().query(User.id).all()</span></code>)</p></li>
<li><p>Convenience functionality:</p>
<ul>
<li><p>Join relationships: some multi-step relationships are defined through joins using the <code class="docutils literal notranslate"><span class="pre">secondary</span></code> parameter to eliminate queries from the intermediate table; e.g., <code class="docutils literal notranslate"><span class="pre">User.acls</span></code> instad of <code class="docutils literal notranslate"><span class="pre">[r.acls</span> <span class="pre">for</span> <span class="pre">r</span> <span class="pre">in</span> <span class="pre">User.roles]</span></code></p></li>
<li><p><a class="reference external" href="http://docs.sqlalchemy.org/en/latest/orm/extensions/associationproxy.html">Association proxies</a>: shortcut to some attribute of a related object; e.g., <code class="docutils literal notranslate"><span class="pre">User.permissions</span></code> instead of <code class="docutils literal notranslate"><span class="pre">[a.id</span> <span class="pre">for</span> <span class="pre">a</span> <span class="pre">in</span> <span class="pre">User.acls]</span></code></p></li>
<li><p><a class="reference external" href="http://docs.sqlalchemy.org/en/latest/orm/loading_relationships.html">Joined loads</a>: this allows for a single query to also include child/related objects; often used in handlers when we know that information about related objects will also be needed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">to_json()</span></code>: often from a handler we return an ORM object, which gets converted to JSON via <code class="docutils literal notranslate"><span class="pre">json_util.to_json(obj.to_dict())</span></code>. This also includes the attributes of any children that were loaded via <code class="docutils literal notranslate"><span class="pre">joinedload</span></code> or by accessing them directly. For example:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">User.query.first().to_dict()</span></code> will not contain information about the user’s permissions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">u</span> <span class="pre">=</span> <span class="pre">User.query.first();</span> <span class="pre">u.acls;</span> <span class="pre">u.to_dict()</span></code> does include a list of the user’s ACLs</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="docker-images">
<h2>Docker images<a class="headerlink" href="#docker-images" title="Permalink to this heading"></a></h2>
<p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">docker-images</span></code> to build and push to Docker hub.</p>
</section>
<section id="debugging-github-actions">
<h2>Debugging GitHub Actions<a class="headerlink" href="#debugging-github-actions" title="Permalink to this heading"></a></h2>
<p>You can insert the following step to debug your workflow:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setup tmate session</span><span class="w"></span>
<span class="w">  </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mxschmitt/action-tmate@v2</span><span class="w"></span>
</pre></div>
</div>
<p>It will print a command that you can use to SSH into the runner.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="api.html" class="btn btn-neutral float-left" title="API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="deploy.html" class="btn btn-neutral float-right" title="Deployment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, The SkyPortal Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>